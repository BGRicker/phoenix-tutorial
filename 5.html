<html>
	<head>
    <script src="https://code.jquery.com/jquery-1.11.2.js"></script>
    <script src="js/lightbox.min.js"></script>
    <link href="css/lightbox.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="style.css">
<script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-542ec3e65052d59e" async></script>


	</head>

	<body>
	<div class="col-xs-10 col-xs-offset-1">
		<h1>Lesson 5</h1>

		<h2>Adding new quotes and creating them in the database</h2>
   <p>
   The first part of the application to allow user generated quotes we'll need is to build a new form where a user is prompted to enter details about the quote they want to add.  Then we can deal with storing the quote in our database.
   </p>

   <h4>Building a new form</h4>

   <p>
   Right now if you navigate to <a href="http://localhost:4000/quotes/new">quotes/new</a>, you'll see an error message indicating we need to add the action to our controller.
   </p>

   <p>
   Edit <code>web/controllers/quote_controller.ex</code> and add the following method to it:
   </p>

<div class="highlight"><pre><span class="k">defmodule</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">QuoteController</span> <span class="k">do</span>
<span class="k">  </span><span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span>

  <span class="n">plug</span> <span class="ss">:action</span>

  <span class="k">def</span> <span class="n">homepage</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;homepage.html&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:quotes</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Splurty</span><span class="o">.</span><span class="no">Quote</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
  <span class="k">end</span>

<div class="emphasis">  <span class="k">def</span> <span class="n">new</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;new.html&quot;</span>
  <span class="k">end</span></div>
<span class="k">end</span>
</pre></div>
<p>
Save the file.
</p>

<p>
Refresh the page.  The error message should change to say that the new.html template doesn't exist.  This makes sense.  Add a file in the <code>web/templates/quote/new.html.eex</code> that looks like this:
</p>

<div class="highlight"><pre>Hello!
</pre></div>

<p>
Save the file and refresh the page.  Awesome the error message goes away and we see a page.
</p>

<p>
We're going to want to use routing aliases in our view (to hook up the action of the form to the create action).  In order to do that, we'll want to add the routing helpers to our app.  Add the following lines of code to <code>web/controllers/quote_controller.ex</code>:
</p>

<div class="highlight"><pre><span class="k">defmodule</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">QuoteController</span> <span class="k">do</span>
<span class="k">  </span><span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span>

<div class="emphasis">  <span class="n">alias</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">Router</span>
  <span class="kn">import</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">Router</span><span class="o">.</span><span class="no">Helpers</span></div>
  <span class="n">plug</span> <span class="ss">:action</span>

  <span class="k">def</span> <span class="n">homepage</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;homepage.html&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:quotes</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Splurty</span><span class="o">.</span><span class="no">Quote</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">new</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;new.html&quot;</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div>

<p>
Save the file, then restart the server.
</p>



<p>
Next let's add the form to the view.  Change the file <code>web/templates/quote/new.html.eex</code> code to look like this:
</p>

<div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>New Quote<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">quote_path</span><span class="p">(</span><span class="vi">@conn</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;quote[saying]&quot;</span><span class="nt">&gt;</span>saying<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;quote[saying]&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;quote[author]&quot;</span><span class="nt">&gt;</span>author<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;quote[author]&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
<p>
Save the file and refresh the page.  Awesome, the form appeared!
</p>

<h3>Dealing with CSRF</h3>

<p>
Next up let's support the create action.  To start with let's see what error message comes up when we press the submit button.
</p>

<p>
It looks like we're getting a CSRF error message.  This indicates we're not passing along a valid CSRF token when we're submitting the form.
</p>

<p>
Add the following helper method to <code>web/view.ex</code> to add a helper method to generate csrf tokens:
</p>

<div class="highlight"><pre><span class="k">defmodule</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">View</span> <span class="k">do</span>
<span class="k">  </span><span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">View</span><span class="p">,</span> <span class="ss">root:</span> <span class="s2">&quot;web/templates&quot;</span>

  <span class="c1"># The quoted expression returned by this block is applied</span>
  <span class="c1"># to this module and all other views that use this module.</span>
  <span class="n">using</span> <span class="k">do</span>
<span class="k">    </span><span class="kn">quote</span> <span class="k">do</span>
<span class="k">      </span><span class="c1"># Import common functionality</span>
      <span class="kn">import</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">Router</span><span class="o">.</span><span class="no">Helpers</span>

      <span class="c1"># Use Phoenix.HTML to import all HTML functions (forms, tags, etc)</span>
      <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">HTML</span>
    <span class="k">end</span>
  <span class="k">end</span>

<div class="emphasis">  <span class="k">def</span> <span class="n">csrf_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:csrf_token</span><span class="p">)</span>
  <span class="k">end</span></div>  <span class="c1"># Functions defined here are available to all other views/templates</span>
<span class="k">end</span>
</pre></div>

<p>
Save the file.  Awesome, add the following snippet to pass through the CSRF token in the action to <code>web/templates/quote/new.html.eex</code>.
</p>



<div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>New Quote<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">quote_path</span><span class="p">(</span><span class="vi">@conn</span><span class="p">,</span> <span class="ss">:create</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
<div class="emphasis">    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;csrf_token&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">csrf_token</span><span class="p">(</span><span class="vi">@conn</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span></div>    
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;quote[saying]&quot;</span><span class="nt">&gt;</span>saying<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;quote[saying]&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;quote[author]&quot;</span><span class="nt">&gt;</span>author<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;quote[author]&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-primary&quot;</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>


<p>
Save the file.
</p>

   <p>
   Navigate to <a href="http://localhost:4000/quotes/new">quotes/new</a> and refresh the page.  Then fill out the form and press the submit button.  Nice, now we see an error message that the controller action is undefined.
   </p>



<h3>Adding the create action</h3>

<p>
We'll need to add an action to the quotes controller to support the create functionality.  Edit <code>web/controllers/quote_controller.ex</code> and add the create method:
</p>

<div class="highlight"><pre><span class="k">defmodule</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">QuoteController</span> <span class="k">do</span>
<span class="k">  </span><span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span>

  <span class="n">alias</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">Router</span>
  <span class="kn">import</span> <span class="no">Splurty</span><span class="o">.</span><span class="no">Router</span><span class="o">.</span><span class="no">Helpers</span>

  <span class="n">plug</span> <span class="ss">:action</span>

  <span class="k">def</span> <span class="n">homepage</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;homepage.html&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">assign</span><span class="p">(</span><span class="ss">:quotes</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Splurty</span><span class="o">.</span><span class="no">Quote</span><span class="p">))</span>
    <span class="o">|&gt;</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">new</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
<span class="k">    </span><span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;new.html&quot;</span>
  <span class="k">end</span>

<div class="emphasis">  <span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="err">%</span><span class="p">{</span><span class="s2">&quot;quote&quot;</span> <span class="o">=&gt;</span> <span class="err">%</span><span class="p">{</span><span class="s2">&quot;saying&quot;</span> <span class="o">=&gt;</span> <span class="n">saying</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="p">}})</span> <span class="k">do</span>
<span class="k">    </span><span class="n">q</span> <span class="o">=</span> <span class="err">%</span><span class="no">Splurty</span><span class="o">.</span><span class="no">Quote</span><span class="p">{</span><span class="ss">saying:</span> <span class="n">saying</span><span class="p">,</span>  <span class="ss">author:</span> <span class="n">author</span><span class="p">}</span>
    <span class="no">Repo</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">redirect</span> <span class="n">conn</span><span class="p">,</span> <span class="ss">to:</span> <span class="n">quote_path</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:index</span><span class="p">)</span>
  <span class="k">end</span></div>
<span class="k">end</span>
</pre></div>

<p>
Save the file.  Try to create a new quote.  Awesome, it seems to work and redirects to the index page.  On the index page you can see the newly added quote.
</p>

<p>
Your application should look
<a href="lesson-5.png" data-lightbox="Lesson 5" data-title="Lesson 5">just like this</a> at this step.
</p>

		<div class="text-center">
		<a href="6.html" class="btn-primary btn">Onward to Lesson 6</a>
		</div>

<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'thefirehoseprojectelixirphoenix'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
</div>




</div>

    <!--  Google Analytics Tracking Pixel -->
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49340848-1', 'thefirehoseproject.com');
  ga('send', 'pageview');

</script>



	</body>
</html>